---
title: "Mooses Movement"
output: html_document
date: "2025-03-23"
---

# Pakete laden
```{r}
library(here)
library(readr)
library(skimr)
library(dplyr)
library(tidyverse)
library(sf)
library(amt)
```

# Pfad automatisch setzen 

```{r}
here::here()
```

# Git Installieren:

Git Programm herunterladen: 
https://git-scm.com/downloads

Notiz: Nach der Installation R neustarten.

Git Projekt beitreten:
Folgendem Git-Ordner beitreten und auf der Website bei GitHub anmelden (Uni-Mail)
Benutzernamen erstellen und an Melanie schicken, damit ihr vollen Zugriff bekommt.

https://github.com/melligld/Mooses

Danach in R "File > New Project > Version Control > Git"

Dort dann den obigen Link einfÃ¼gen, damit ladet ihr den Git-Ordner herunter. 

================================
ğŸ“¦ Git-Workflow fÃ¼r das R-Projekt
================================
ğŸ›  1. Git einrichten (nur einmal notwendig)
Gebt euren Namen und eure E-Mail-Adresse an, damit eure Commits zugeordnet werden kÃ¶nnen:
Im Terminal:
git config --global user.name "Username"
git config --global user.email "MaxMustermann@campus.tu-berlin.de"

=====================================
ğŸš€ TÃ¤glicher Workflow mit Git in RStudio
=====================================

1ï¸âƒ£ Vor dem Arbeiten: Ã„nderungen von anderen holen
(Git-Tab in RStudio â†’ Klick auf â€Pullâ€œ)
oder im Terminal: git pull

2ï¸âƒ£ Dann wie gewohnt arbeiten:
- Skripte oder Dateien Ã¤ndern
- Ergebnisse speichern

3ï¸âƒ£ Ã„nderungen zum Commit auswÃ¤hlen:
(Git-Tab â†’ HÃ¤kchen bei den geÃ¤nderten Dateien setzen)

4ï¸âƒ£ Commit erstellen:
- Im Git-Tab Nachricht schreiben (z.B. â€Analyse ergÃ¤nztâ€œ)
- Dann auf â€Commitâ€œ klicken

5ï¸âƒ£ Ã„nderungen hochladen:
- Git-Tab â†’ â€Pushâ€œ klicken
oder im Terminal: git push

ğŸ’¡ Tipp: Lieber hÃ¤ufiger kleine Commits machen statt einen groÃŸen am Ende!

=====================================
âœ… Zusammengefasst:
=====================================
git pull     â†’ aktuelle Ã„nderungen holen
git add .    â†’ alle Ã„nderungen fÃ¼r Commit vormerken (meist Ã¼ber Git-Tab gemacht)
git commit -m "Kurze Nachricht" â†’ Ã„nderung speichern
git push     â†’ Ã„nderungen ins GitHub-Projekt hochladen

=====================================
â—ï¸Wichtig:
=====================================
â¤ Immer vor dem Arbeiten zuerst ein `pull` machen.
â¤ Nur pushen, wenn du committed hast und keine Konflikte offen sind.



# Alle CSVs einlesen und zusammenfÃ¼gen 

```{r}
# Ordnerpfad zu den CSV-Dateien
data_path <- here("data")
sex_data_path <- here("data", "sex_data", "Peters_Hebblewhite_Alberta-BC_Moose-reference-data.csv")
# Liste aller CSV-Dateien im data-Ordner
csv_files <- list.files(path = data_path, pattern = "\\.csv$", full.names = TRUE)

# Alle CSVs einlesen und zu einem Dataframe zusammenfÃ¼gen
moose_data <- purrr::map_dfr(csv_files, read_csv, .id = "source_file", show_col_types= FALSE)
colnames(moose_data)[colnames(moose_data) == "tag.local.identifier"] <- "id"

#Geschlechter Zuordnung
sex<- read.csv(sex_data_path)
colnames(sex)[colnames(sex) == "animal.id"] <- "id"

#Moose Datensatz mit Geschlechterzuordnung
moose_data_sex <- moose_data %>%
  left_join(sex[, c("id", "animal.sex")], by = "id")

```

## Anzeigen lassen welche Dateien drin sind

```{r}
glimpse(moose_data)
unique(moose_data$source_file)

```

## Spalten vereinfachen und umbennen
```{r}
moose_data_sex <- moose_data_sex %>%
  rename(
    lat = location.lat,
    lon = location.long,
    time = timestamp
  )
```

```{r}
## Aufnahmezeitraum anschauen
moose_data_sex$yearday <- yday(moose_data_sex$time)
moose_data_sex$month   <- month(moose_data_sex$time)
moose_data_sex$hour    <- hour(moose_data_sex$time)
moose_data_sex$kweek   <- week(moose_data_sex$time)
moose_data_sex$date    <- date(moose_data_sex$time)
ggplot(moose_data_sex, aes(date)) +
  geom_bar() +
  theme_bw()
ggsave("Output/moose_timestamp_histogram.png", width = 10, height = 6, dpi = 300)

```

## Erste Bewegung visualisieren 

```{r}
library(ggplot2)

ggplot(moose_data_sex %>% filter(id == 1), aes(x = lon, y = lat)) +
  geom_path(color = "darkgreen") +
  labs(title = "Bewegungspfad von Elch 1", x = "Longitude", y = "Latitude") +
  theme_minimal()


ggplot(moose_data_sex, aes(x = lon, y = lat, color = factor(id))) +
  geom_path(alpha = 0.6) +
  labs(title = "Bewegungspfade aller Elche", color = "Elch-ID") +
  theme_minimal()

```


```{r}
# Daten in sf-Objekt umwandeln (WGS84-Koordinatensystem)
moose_sf <- st_as_sf(moose_data_sex, coords = c("lon", "lat"), crs = 4326)
moose_proj <- st_transform(moose_sf, crs = 3395)

bbox <- st_bbox(moose_proj)

# In ein Rechteck umwandeln
bbox_poly <- st_as_sfc(bbox)

# Jetzt 50.000 Meter (50 km) puffern
bbox_puffer <- st_buffer(bbox_poly, dist = 50000)
bbox_puffer_wgs <- st_transform(bbox_puffer, crs = 4326)

ggplot() +
  geom_sf(data = bbox_puffer_wgs, fill = NA, color = "red") +
  geom_sf(data = moose_sf, color = "blue", size = 0.5) +
  theme_minimal()
```

```{r}
install.packages("rgee")
library(rgee)

# Einmalig initialisieren:
ee_install()
ee_Initialize()
```

```{r}
#1. Dataframe mit Koordinaten erstellen
moose_coords <- as.data.frame(st_coordinates(moose_proj))
str(moose_coords)
moose_proj$X <- moose_coords$X
moose_proj$Y <- moose_coords$Y
#remove the spatial (geometry) column-> Converts the sf object into a regular data frame
moose_ng<- st_drop_geometry(moose_proj)
str(moose_ng)

#2. amt Objekt erstellen FÃœR EINZELNES TIER
moose1 <- moose_ng[moose_ng$id == "1", ] 
moose1_amt<- make_track(tbl= moose1, #make_track converts non-spatial data into a movement track object
                         .x= X,
                         .y= Y,
                         .t= time,
                         id= id, 
                         crs= 3979)
#3. KDE berechnen FÃœR EINZELNES TIER
kde_moose1_95 <- amt::hr_kde(x = moose1_amt, levels = c(0.95))
plot(kde_moose1_95)
hr_area(kde_moose1_95) #82887271

#4. AMT Objekt erstellen fÃ¼r GESAMT KDE BERECHNUNG
moose_ng <- moose_ng %>%
  filter(!is.na(time))
moose_amt<- make_track(tbl= moose_ng, 
                         .x= X,
                         .y= Y,
                         .t= time,
                         id= id, 
                         crs= 3979)
kde_moose_95 <- amt::hr_kde(x = moose_amt, levels = c(0.95))
plot(kde_moose_95)

#KDE fÃ¼r jedes Tier einzeln aus "gemeinsamen" amt objekt
#in tibbel umwandeln 
moose_amt_tbl <- as_tibble(moose_amt)
#gesamtergebnisse nach individuen filteren
kde_results <- moose_amt_tbl %>%
  group_by(id) %>%
  nest() %>%
  mutate(kde = map(data, ~ hr_kde(make_track(.x, .x = x_, .y = y_, .t = t_), levels = c(0.95))))  # Convert back to track
print(kde_results)
walk(kde_results$kde, plot)

#fÃ¼r jedes Tier ausgeben lassen
kde_results <- kde_results %>%
  mutate(area = map(kde, ~ hr_area(.x)$area)) 
print(kde_results)
walk(kde_results$area, print)

#12 kontrolle
kde_moose12 <- kde_results[kde_results$id == "12", ]
kde_moose12 <- kde_results %>% filter(id == "12")
kde_moose12_kde <- kde_moose12$kde[[1]]
kde_area_moose12 <- hr_area(kde_moose12_kde)
```

```{r}
#Neuen Datensatz erstellen mit FlÃ¤chenangaben und Geschlecht fÃ¼r Visualisierung ect.
#Sex datensatz als basis- alle Spalten mit nur NA entfernen
moose_data_sex_area<- sex %>%
  select(where(~ !all(is.na(.))))
#Area spalte aus kde_results anhÃ¤ngen
moose_data_sex_area <- moose_data_sex_area %>%
  left_join(kde_results %>% select(id, area), by = "id")
#Bearbeitug Datensatz
moose_data_sex_area$area<- as.numeric(moose_data_sex_area$area)
#Individuen mit unvollstÃ¤ndigen Daten rauslÃ¶schen
moose_data_sex_area <- moose_data_sex_area[!moose_data_sex_area$id %in% c("9", "31"), ]
#Area Angaben in km^2 umrechnen
moose_data_sex_area$area<- moose_data_sex_area$area/1000000

boxplot(area ~ animal.sex, data = moose_data_sex_area, 
        ylim = c(0, 6000),
        main = "Home Range Area by Sex",
        xlab = "Sex",
        ylab = "Area (mÂ²)")

#Signifikanztest auf Unterschiede zwischen den Geschlechtern
hist(as.numeric(moose_data_sex_area$area))
wilcox.test(as.numeric(moose_data_sex_area$area)~moose_data_sex_area$animal.sex)

```


